<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BTX Agenda • Bloco Premium</title>

<style>
:root{
  --borda:#111827;
  --cinza:#6b7280;
  --fundo:#f3f4f6;
  --papel:#f9fafb;
  --texto:#0b1220;
  --card:#ffffff;
}

*{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

body{
  margin:0;
  background:var(--fundo);
  color:var(--texto);
}

.app{
  max-width:1100px;
  margin:0 auto;
  padding:14px;
  display:grid;
  gap:12px;
  grid-template-columns: 320px 1fr;
}

@media (max-width: 860px){
  .app{ grid-template-columns: 1fr; }
}

/* ===== SIDEBAR ===== */
.sidebar{
  background:var(--card);
  border:1.5px solid #d1d5db;
  border-radius:14px;
  padding:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.06);
}

.brand{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:6px 4px 10px 4px;
  border-bottom:1px solid #e5e7eb;
}
.brand h2{
  margin:0;
  font-size:15px;
  letter-spacing:.6px;
}
.badge{
  font-size:11px;
  padding:6px 8px;
  border:1px solid #d1d5db;
  border-radius:999px;
  color:var(--cinza);
}

.sideBlock{ margin-top:12px; }

label{
  font-size:12px;
  font-weight:700;
  display:block;
  margin-bottom:6px;
}

input, textarea, button{
  width:100%;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-size:14px;
}

input, textarea{
  padding:10px;
  background:white;
}

textarea{ resize:vertical; min-height:110px; }

.btnRow{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:8px;
  margin-top:10px;
}

button{
  padding:10px 12px;
  cursor:pointer;
  background:white;
  font-weight:700;
}
button:hover{ filter:brightness(.98); }
.primary{
  background:#111827;
  color:white;
  border-color:#111827;
}
.danger{
  border-color:#ef4444;
  color:#ef4444;
}
.small{
  font-size:12px;
  padding:9px 10px;
}

/* ===== LISTA DE DIAS ===== */
.list{
  margin-top:10px;
  border-top:1px dashed #e5e7eb;
  padding-top:10px;
  max-height:320px;
  overflow:auto;
}

.dayItem{
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:10px;
  margin-bottom:8px;
  background:#fff;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
}
.dayItem strong{ font-size:13px; display:block; }
.dayItem span{ font-size:12px; color:var(--cinza); }
.dayItem button{
  width:auto;
  padding:8px 10px;
  font-size:12px;
  border-radius:10px;
}

/* ===== EDITOR ===== */
.editor{
  background:var(--papel);
  border:2px solid var(--borda);
  border-radius:16px;
  padding:18px;
  box-shadow:0 10px 28px rgba(0,0,0,.08);
}

.header{
  text-align:center;
  padding-bottom:12px;
  border-bottom:1px solid var(--borda);
  margin-bottom:14px;
}
.header h1{
  margin:0;
  font-size:18px;
  letter-spacing:1px;
}
.header .meta{
  margin-top:6px;
  font-size:13px;
  color:var(--cinza);
}

.grid2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
}
@media (max-width: 860px){
  .grid2{ grid-template-columns: 1fr; }
}

.field{ margin-bottom:12px; }
.field label{ margin-bottom:6px; }
.field input, .field textarea{ border-radius:12px; }

.attach{
  margin-top:8px;
  padding-top:10px;
  border-top:1px dashed #d1d5db;
}
.preview{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}
.preview .imgBox{
  width:130px;
  border:1px solid #d1d5db;
  border-radius:12px;
  overflow:hidden;
  background:white;
}
.preview img{
  width:100%;
  height:120px;
  object-fit:cover;
  display:block;
}
.preview .imgActions{
  padding:8px;
  display:flex;
  gap:6px;
}
.preview .imgActions button{
  width:auto;
  padding:7px 8px;
  font-size:12px;
  border-radius:10px;
}

.footer{
  margin-top:14px;
  padding-top:10px;
  border-top:1px solid var(--borda);
  color:var(--cinza);
  font-size:12px;
  text-align:center;
}

/* ===== IMPRESSÃO ===== */
@media print{
  body{ background:white; }
  .app{ display:block; padding:0; }
  .sidebar{ display:none !important; }
  .editor{
    box-shadow:none;
    border-radius:0;
    max-width:100%;
    min-height:100vh;
  }
  input, textarea{
    border:none !important;
    padding:0 !important;
    background:transparent !important;
  }
  .attach input, .preview .imgActions, .btnRow, .footerHint { display:none !important; }
}
</style>
</head>

<body>
<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <h2>BTX Agenda</h2>
      <div class="badge">offline • multi-dias</div>
    </div>

    <div class="sideBlock">
      <label>Escolher dia</label>
      <input id="datePicker" type="date" />
      <div class="btnRow">
        <button class="primary" onclick="saveNow()">Salvar</button>
        <button onclick="newDay()">Novo dia</button>
      </div>
      <div class="btnRow">
        <button class="small" onclick="printPDF()">Gerar PDF/Imprimir</button>
        <button class="small danger" onclick="deleteDay()">Apagar dia</button>
      </div>
    </div>

    <div class="sideBlock">
      <label>Backup</label>
      <div class="btnRow">
        <button class="small" onclick="exportBackup()">Exportar</button>
        <button class="small" onclick="document.getElementById('importFile').click()">Importar</button>
      </div>
      <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importBackup(event)" />
    </div>

    <div class="sideBlock">
      <label>Dias salvos</label>
      <div class="list" id="daysList"></div>
    </div>

    <div class="footerHint" style="margin-top:10px;color:var(--cinza);font-size:12px;">
      Dica: o PDF sai pelo “Imprimir → Salvar como PDF”.
    </div>
  </aside>

  <!-- EDITOR -->
  <main class="editor" id="printArea">
    <div class="header">
      <h1>AGENDA / BLOCO DE NOTAS</h1>
      <div class="meta" id="humanDate">—</div>
    </div>

    <div class="grid2">
      <div class="field">
        <label>Paciente / Assunto</label>
        <input id="title" placeholder="Ex.: Consulta João, Estudo Obstetrícia, Planejamento..." />
      </div>
      <div class="field">
        <label>Status do dia</label>
        <input id="status" placeholder="Ex.: ok / retorno / pendente / urgência..." />
      </div>
    </div>

    <div class="grid2">
      <div class="field">
        <label>Resumo / Evolução</label>
        <textarea id="resumo" placeholder="Evolução clínica, pontos-chave, achados..."></textarea>
      </div>
      <div class="field">
        <label>Conduta / Lembretes</label>
        <textarea id="conduta" placeholder="Exames, medicações, retorno, tarefas, pendências..."></textarea>
      </div>
    </div>

    <div class="attach">
      <label>Anexos (foto do dia, exame, registro)</label>
      <input id="fileInput" type="file" accept="image/*" multiple />
      <div class="preview" id="preview"></div>
    </div>

    <div class="footer">
      Documento organizado • bordas elegantes • impressão limpa
    </div>
  </main>

</div>

<script>
/* =========================
   IndexedDB (para anexos)
========================= */
const DB_NAME = "btx_agenda_db";
const DB_VER  = 1;
const STORE   = "days";

let db = null;
let currentDateKey = null;
let autosaveTimer = null;

function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e)=>{
      const d = e.target.result;
      if(!d.objectStoreNames.contains(STORE)){
        d.createObjectStore(STORE, { keyPath: "date" });
      }
    };
    req.onsuccess = ()=>{ db = req.result; resolve(db); };
    req.onerror = ()=> reject(req.error);
  });
}

function tx(mode="readonly"){
  return db.transaction(STORE, mode).objectStore(STORE);
}

function idbGet(date){
  return new Promise((resolve,reject)=>{
    const r = tx("readonly").get(date);
    r.onsuccess = ()=> resolve(r.result || null);
    r.onerror = ()=> reject(r.error);
  });
}

function idbPut(obj){
  return new Promise((resolve,reject)=>{
    const r = tx("readwrite").put(obj);
    r.onsuccess = ()=> resolve(true);
    r.onerror = ()=> reject(r.error);
  });
}

function idbDelete(date){
  return new Promise((resolve,reject)=>{
    const r = tx("readwrite").delete(date);
    r.onsuccess = ()=> resolve(true);
    r.onerror = ()=> reject(r.error);
  });
}

function idbGetAll(){
  return new Promise((resolve,reject)=>{
    const r = tx("readonly").getAll();
    r.onsuccess = ()=> resolve(r.result || []);
    r.onerror = ()=> reject(r.error);
  });
}

/* =========================
   Util
========================= */
function fmtHuman(dateStr){
  const [y,m,d] = dateStr.split("-").map(Number);
  const dt = new Date(y, m-1, d);
  return dt.toLocaleDateString("pt-BR", { weekday:"long", day:"2-digit", month:"long", year:"numeric" });
}

function todayKey(){
  const dt = new Date();
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const d = String(dt.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}

function readForm(){
  return {
    title: document.getElementById("title").value.trim(),
    status: document.getElementById("status").value.trim(),
    resumo: document.getElementById("resumo").value.trim(),
    conduta: document.getElementById("conduta").value.trim()
  };
}

function setForm(data){
  document.getElementById("title").value = data?.title || "";
  document.getElementById("status").value = data?.status || "";
  document.getElementById("resumo").value = data?.resumo || "";
  document.getElementById("conduta").value = data?.conduta || "";
}

function renderPreview(images=[]){
  const box = document.getElementById("preview");
  box.innerHTML = "";
  images.forEach((src, idx)=>{
    const wrap = document.createElement("div");
    wrap.className = "imgBox";
    wrap.innerHTML = `
      <img src="${src}" alt="anexo"/>
      <div class="imgActions">
        <button onclick="removeImage(${idx})">Remover</button>
      </div>
    `;
    box.appendChild(wrap);
  });
}

/* =========================
   Estado do dia
========================= */
let currentImages = [];

async function loadDay(dateStr){
  currentDateKey = dateStr;
  document.getElementById("humanDate").innerText = fmtHuman(dateStr);

  const saved = await idbGet(dateStr);
  if(saved){
    setForm(saved);
    currentImages = saved.images || [];
    renderPreview(currentImages);
  } else {
    setForm(null);
    currentImages = [];
    renderPreview(currentImages);
  }
  await refreshDaysList();
}

async function saveNow(showToast=true){
  if(!currentDateKey) return;
  const data = readForm();
  const obj = {
    date: currentDateKey,
    ...data,
    images: currentImages,
    updatedAt: Date.now()
  };
  await idbPut(obj);
  await refreshDaysList();
  if(showToast) quickFlash("Salvo ✅");
}

function scheduleAutosave(){
  clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(()=> saveNow(false), 450);
}

function quickFlash(text){
  const b = document.querySelector(".badge");
  const old = b.innerText;
  b.innerText = text;
  setTimeout(()=> b.innerText = old, 900);
}

/* =========================
   Lista de dias
========================= */
async function refreshDaysList(){
  const all = await idbGetAll();
  all.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));

  const list = document.getElementById("daysList");
  list.innerHTML = "";

  if(all.length === 0){
    list.innerHTML = `<div style="color:var(--cinza);font-size:12px;padding:10px;">Nenhum dia salvo ainda.</div>`;
    return;
  }

  all.forEach(item=>{
    const title = (item.title || "").slice(0,34);
    const resumo = (item.resumo || "").replace(/\n/g," ").slice(0,38);
    const el = document.createElement("div");
    el.className = "dayItem";
    el.innerHTML = `
      <div>
        <strong>${fmtHuman(item.date)}</strong>
        <span>${title || resumo || "Sem título (mas salvo)"}</span>
      </div>
      <button onclick="jumpTo('${item.date}')">Abrir</button>
    `;
    list.appendChild(el);
  });
}

function jumpTo(dateStr){
  document.getElementById("datePicker").value = dateStr;
  loadDay(dateStr);
}

/* =========================
   Anexos
========================= */
document.getElementById("fileInput").addEventListener("change", async (e)=>{
  const files = Array.from(e.target.files || []);
  for(const file of files){
    const dataUrl = await fileToDataURL(file);
    currentImages.push(dataUrl);
  }
  renderPreview(currentImages);
  scheduleAutosave();
  e.target.value = "";
});

function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = ()=> reject(r.error);
    r.readAsDataURL(file);
  });
}

function removeImage(idx){
  currentImages.splice(idx,1);
  renderPreview(currentImages);
  scheduleAutosave();
}

/* =========================
   Ações
========================= */
function newDay(){
  const t = todayKey();
  document.getElementById("datePicker").value = t;
  loadDay(t);
}

async function deleteDay(){
  if(!currentDateKey) return;
  const ok = confirm("Apagar esse dia e todos os anexos? (sem volta)");
  if(!ok) return;
  await idbDelete(currentDateKey);
  newDay();
  await refreshDaysList();
}

function printPDF(){
  // Só chama a impressão (usuário salva como PDF)
  window.print();
}

/* =========================
   Backup JSON
========================= */
async function exportBackup(){
  const all = await idbGetAll();
  const blob = new Blob([JSON.stringify({version:1, exportedAt: Date.now(), days: all}, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `btx_agenda_backup_${todayKey()}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

async function importBackup(event){
  const file = event.target.files?.[0];
  if(!file) return;

  try{
    const text = await file.text();
    const json = JSON.parse(text);
    const days = json.days || [];
    for(const day of days){
      if(day?.date){
        await idbPut(day);
      }
    }
    quickFlash("Importado ✅");
    await refreshDaysList();

    // abre o mais recente importado
    const all = await idbGetAll();
    all.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
    if(all[0]) jumpTo(all[0].date);

  }catch(err){
    alert("Falha ao importar backup. Verifica se o arquivo é um JSON válido.");
  }finally{
    event.target.value = "";
  }
}

/* =========================
   Eventos (autosave)
========================= */
["title","status","resumo","conduta"].forEach(id=>{
  document.getElementById(id).addEventListener("input", scheduleAutosave);
});

document.getElementById("datePicker").addEventListener("change", (e)=>{
  const v = e.target.value;
  if(v) loadDay(v);
});

/* =========================
   Inicialização
========================= */
(async function init(){
  await openDB();
  const t = todayKey();
  document.getElementById("datePicker").value = t;
  await loadDay(t);
})();
</script>

</body>
</html>
